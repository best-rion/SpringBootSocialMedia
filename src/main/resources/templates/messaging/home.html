<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/nav.css}">
    <title>Messaging Home</title>
</head>
<body>
	
	<nav>
		<a class="nav-item" th:href="@{/}">Home</a>
		<a class="nav-item" th:href="@{/profile/}+${principal.name}">Profile</a>
		<a class="nav-item" th:href="@{/makePost}">Make Post</a>
		<a class="nav-item" th:href="@{/messaging}">Message</a>
		<a class="nav-item" th:href="@{/friends}">Find Friends</a>
		<a class="nav-item" th:href="@{/logout}">Logout</a>
	</nav>

    <div class="container">

		<div id="connect" style="width: 100px; text-align: center; background-color: #BFECFF;">Connnecting...</div>
		
		<div class="row">
			
			<div class="col-md-6">

				<h2>Messages</h2>
	
				<ul>
				    <li th:each="notification: ${notifications}">
				        <a th:href="@{/messaging/chat/}+${notification.sender}" th:text="${notification.sender}"></a>
						<span th:if="${notification.numberOfMessages > 0}">ðŸ’¬<span th:text="${notification.numberOfMessages}"></span></span>
				    </li>
				</ul>
			
			</div>		
				
			<div class="col-md-6">
				<input type="text" id="principal" th:value="${principal.name}" hidden>
				
				<h2>Play Tic-Tac-Toe</h2>
				
				<h3 style="color: #44b5d5;">Challengers</h3>
				<ul id="challengers" style="list-style-type: none;">
				</ul>
				
				<h3 style="color: #2596be;">Active Users</h3>
				<ul id="activeUsers" style="list-style-type: none;">
				</ul>
				
			</div>
			
		</div>
		
    </div>
	
	<script>

			const stompClient = new StompJs.Client({
			    brokerURL: 'ws://10.18.122.174:8080/gs-guide-websocket'
			});
			
			window.onload = ()=>{
				stompClient.activate();
			}
			
			stompClient.onConnect = (frame) => {
				
		        console.log('Connected: ' + frame);
				
				$("#connect").html("connected")
				
				stompClient.subscribe('/topic/updateUsers', (users) => {
					insertActiveUsers(JSON.parse(users.body));
		        });
				
				stompClient.subscribe('/user/queue/challenge', (user) => {
					
					$("#challengers").append(
						"<li id=\""+user.body+"\">"+
							"<a href=\"/game/challenge/"+user.body+"\">"+user.body+"</a><br>"+
						"</li>"
					);
					
		        });
				
				stompClient.subscribe('/user/queue/unchallenge', (user) => {
					
					$("#"+user.body).remove()

		        });		
				
				stompClient.publish({
				    destination: "/app/enterDashboard",
				    body: JSON.stringify({'username':$("#principal").val()})
				});
		    };
			
			function insertActiveUsers(users)
			{
				$("#activeUsers").html('');

				for (var i=0; i<users.length; i++)
				{
					if (users[i] != $("#principal").val())
					{

					console.log($("#principal").val()+"  "+users[i]);
						$("#activeUsers").append(
							"<li id=\""+users[i]+"\">"+
								"<a href=\"/game/challenge/"+users[i]+"\">"+users[i]+"</a>"+
							"</li>"
						);
					}
				}
			}
		    
		    stompClient.onWebSocketError = (error) => {
		        console.error('Error with websocket', error);
		    };

		    stompClient.onStompError = (frame) => {
		        console.error('Broker reported error: ' + frame.headers['message']);
		        console.error('Additional details: ' + frame.body);
		    };
			
			window.onbeforeunload = function () {
				stompClient.publish({
				    destination: "/app/leaveDashboard",
				    body: JSON.stringify({'username':$("#principal").val()})
				});
				
				stompClient.deactivate();
			};

		</script>
	
    
</body>
</html>